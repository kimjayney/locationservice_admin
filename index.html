<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootstrap Navbar Example</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">AdminSite</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">

                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Cloudflare D1 Insights</h1>
        <p>아래 버튼을 클릭하여 Express 서버를 통해 D1 분석 데이터를 가져옵니다.</p>
        <div class="row g-3 align-items-center mb-3 p-3 border rounded bg-light">
            <div class="col-auto">
                <label for="startDate" class="col-form-label">시작일</label>
            </div>
            <div class="col-auto">
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="col-auto">
                <label for="endDate" class="col-form-label">종료일</label>
            </div>
            <div class="col-auto">
                <input type="date" id="endDate" class="form-control">
            </div>
        </div>
        <div class="mt-2">
            <button id="fetchDataBtn" class="btn btn-primary">D1 사용량 불러오기</button>
            <button id="fetchQueriesBtn" class="btn btn-secondary">최근 실행 쿼리 보기</button>
            <button id="parseAllQueriesBtn" class="btn btn-success" disabled>모든 쿼리 파싱하기</button>
            <button id="downloadS3Btn" class="btn btn-info">S3 로그 다운로드</button>
            <button id="readS3Btn" class="btn btn-warning">S3 로그 불러오기</button>
            <button id="parseAllS3QueriesBtn" class="btn btn-dark" disabled>모든 쿼리 파싱하기 (S3)</button>
        </div>

        <div id="results" class="mt-4">
            <!-- 분석 데이터가 여기에 표시됩니다. -->
        </div>
        <div id="queries-results" class="mt-4">
            <!-- 쿼리 데이터가 여기에 표시됩니다. -->
        </div>
        <div id="s3-results" class="mt-4">
            <!-- S3 다운로드 결과가 여기에 표시됩니다. -->
        </div>
        <div id="s3-content-results" class="mt-4">
            <!-- S3 로그 내용이 여기에 표시됩니다. -->
        </div>

        <!-- 파싱된 쿼리를 보여줄 모달 -->
        <div class="modal fade" id="queryParseModal" tabindex="-1" aria-labelledby="queryParseModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="queryParseModalLabel">파싱된 내부 쿼리</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <textarea id="parsedQueryTextarea" class="form-control" rows="10" readonly></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        const endDateInput = document.getElementById('endDate');
        const startDateInput = document.getElementById('startDate');
        let usageChart = null; // 차트 인스턴스를 저장할 변수
        let queriesData = []; // 쿼리 데이터를 다른 이벤트 리스너에서 접근할 수 있도록 전역 변수로 선언
        let s3LogsData = {}; // S3 로그 데이터를 저장할 전역 변수

        // 날짜 입력 필드의 기본값을 설정합니다 (어제 ~ 오늘)
        const toISODateString = (date) => date.toISOString().split('T')[0];
        
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);

        endDateInput.value = toISODateString(today);
        startDateInput.value = toISODateString(yesterday);


        document.getElementById('fetchDataBtn').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <strong>데이터를 불러오는 중...</strong>
                    <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
                </div>`;

            try {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;

                // 선택된 날짜를 쿼리 파라미터로 추가하여 API를 호출합니다.
                const response = await fetch(`/api/insights?start_date=${startDate}&end_date=${endDate}`); 
                const jsonResponse = await response.json();

                if (!response.ok || jsonResponse.errors) {
                    const errorMessage = jsonResponse.errors ? jsonResponse.errors.map(e => e.message).join(', ') : jsonResponse.error;
                    throw new Error(errorMessage);
                }

                // GraphQL 응답 구조에 맞게 데이터 추출
                const analyticsData = jsonResponse.data.viewer.accounts[0].d1AnalyticsAdaptiveGroups;

                if (!analyticsData || analyticsData.length === 0) {
                    resultsDiv.innerHTML = '<p>지난 1일간의 데이터가 없습니다.</p>';
                    return;
                }

                // 테이블의 각 행을 생성
                const tableRows = analyticsData.map(item => {
                    const timestamp = new Date(item.dimensions.date).toLocaleDateString();
                    const reads = item.sum.readQueries.toLocaleString();
                    const writes = item.sum.writeQueries.toLocaleString();
                    return `
                        <tr>
                            <td>${timestamp}</td>
                            <td>${reads}</td>
                            <td>${writes}</td>
                        </tr>
                    `;
                }).join('');
                
                // 결과를 테이블 형태로 렌더링
                // Bootstrap 그리드를 사용하여 테이블과 차트를 좌우로 배치합니다.
                resultsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h3>D1 사용량 (${startDate} ~ ${endDate})</h3>
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>시간</th>
                                        <th>읽기 쿼리</th>
                                        <th>쓰기 쿼리</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <canvas id="usageChartCanvas"></canvas>
                        </div>
                    </div>
                `;

                // --- 차트 생성 로직 ---
                // 시간순으로 정렬하기 위해 데이터를 뒤집습니다.
                const reversedData = [...analyticsData].reverse();

                const labels = reversedData.map(item => new Date(item.dimensions.date).toLocaleDateString());
                const readData = reversedData.map(item => item.sum.readQueries);
                const writeData = reversedData.map(item => item.sum.writeQueries);

                const chartCanvas = document.getElementById('usageChartCanvas');
                
                // 이전에 생성된 차트가 있다면 파괴합니다.
                if (usageChart) {
                    usageChart.destroy();
                }

                usageChart = new Chart(chartCanvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '읽기 쿼리',
                                data: readData,
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '쓰기 쿼리',
                                data: writeData,
                                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '읽기/쓰기 쿼리 사용량'
                            }
                        }
                    }
                });
            } catch (error) {
                resultsDiv.innerHTML = `<p class="text-danger">데이터를 불러오는 데 실패했습니다: ${error.message}</p>`;
            }
        });

        document.getElementById('fetchQueriesBtn').addEventListener('click', async () => {
            const queriesResultsDiv = document.getElementById('queries-results');
            queriesResultsDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <strong>쿼리 목록을 불러오는 중...</strong>
                    <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
                </div>`;

            try {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                const response = await fetch(`/api/queries?start_date=${startDate}&end_date=${endDate}`); // 새로 만든 쿼리 API 호출
                const jsonResponse = await response.json();

                if (!response.ok || jsonResponse.errors) {
                    const errorMessage = jsonResponse.errors ? jsonResponse.errors.map(e => e.message).join(', ') : jsonResponse.error;
                    throw new Error(errorMessage);
                }

                // 전역 변수에 쿼리 데이터 저장
                queriesData = jsonResponse.data.viewer.accounts[0].d1QueriesAdaptiveGroups;

                if (!queriesData || queriesData.length === 0) {
                    queriesResultsDiv.innerHTML = '<p>지난 1일간 실행된 쿼리가 없습니다.</p>';
                    return;
                }

                const tableRows = queriesData.map((item, index) => {
                    const fullQuery = item.dimensions.query || '';
                    // SQL 쿼리 문자열을 안전하게 표시하기 위해 pre 태그 사용
                    const queryDisplay = `<pre class="mb-0 bg-light p-2 rounded" style="white-space: pre-wrap; word-break: break-all;">${fullQuery}</pre>`;

                    return `
                        <tr>
                            <td>${queryDisplay}</td>
                        </tr>
                    `;
                }).join('');

                queriesResultsDiv.innerHTML = `
                    <h3>최근 실행된 쿼리 (최대 100개)</h3>
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>쿼리</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                `;

                // "모든 쿼리 파싱하기" 버튼 활성화
                document.getElementById('parseAllQueriesBtn').disabled = false;

            } catch (error) {
                queriesResultsDiv.innerHTML = `<p class="text-danger">쿼리 목록을 불러오는 데 실패했습니다: ${error.message}</p>`;
            }
        });

        document.getElementById('parseAllQueriesBtn').addEventListener('click', () => {
            if (queriesData.length === 0) {
                alert('먼저 "최근 실행 쿼리 보기"를 실행하여 쿼리 목록을 불러와주세요.');
                return;
            }

            const allParsedQueries = queriesData
                .map(item => {
                    const fullQuery = item.dimensions.query || '';
                    const match = fullQuery.match(/^INSERT INTO AuditLogs.*?VALUES\('((?:[^']|'')*)'/);
                    if (match && match[1]) {
                        return match[1].replace(/''/g, "'");
                    }
                    return null;
                })
                .filter(q => q !== null); // 파싱에 실패한 항목(null)은 제외

            const queryParseModal = new bootstrap.Modal(document.getElementById('queryParseModal'));
            const parsedQueryTextarea = document.getElementById('parsedQueryTextarea');

            parsedQueryTextarea.value = allParsedQueries.length > 0 ? allParsedQueries.join('\n\n---\n\n') : "파싱 가능한 쿼리가 없습니다.";
            queryParseModal.show();
        });

        document.getElementById('downloadS3Btn').addEventListener('click', async () => {
            const s3ResultsDiv = document.getElementById('s3-results');
            s3ResultsDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <strong>S3에서 로그 파일을 다운로드하는 중...</strong>
                    <div class="spinner-border ms-auto text-info" role="status" aria-hidden="true"></div>
                </div>`;
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            try {
                const response = await fetch(`/api/download-s3-logs?start_date=${startDate}&end_date=${endDate}`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'An unknown error occurred.');
                }

                const successList = result.success.map(file => `<li class="list-group-item list-group-item-success">${file}</li>`).join('');
                const failedList = result.failed.map(file => `<li class="list-group-item list-group-item-danger">${file}</li>`).join('');

                s3ResultsDiv.innerHTML = `
                    <h3>S3 로그 다운로드 결과</h3>
                    <h5>성공</h5>
                    <ul class="list-group mb-3">
                        ${successList || '<li class="list-group-item">성공한 파일이 없습니다.</li>'}
                    </ul>
                    <h5>실패</h5>
                    <ul class="list-group">
                        ${failedList || '<li class="list-group-item">실패한 파일이 없습니다.</li>'}
                    </ul>
                `;
            } catch (error) {
                s3ResultsDiv.innerHTML = `<p class="text-danger">S3 로그 다운로드에 실패했습니다: ${error.message}</p>`;
            }
        });

        document.getElementById('readS3Btn').addEventListener('click', async () => {
            const s3ContentResultsDiv = document.getElementById('s3-content-results');
            s3ContentResultsDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <strong>로컬 S3 로그 파일을 읽는 중...</strong>
                    <div class="spinner-border ms-auto text-warning" role="status" aria-hidden="true"></div>
                </div>`;
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            try {
                const response = await fetch(`/api/read-s3-logs?start_date=${startDate}&end_date=${endDate}`);
                const logsByFile = await response.json();

                // 전역 변수에 S3 로그 데이터 저장
                s3LogsData = logsByFile;

                if (!response.ok) {
                    throw new Error(logsByFile.error || 'An unknown error occurred.');
                }

                let accordionHTML = '<div class="accordion" id="s3LogsAccordion">';
                let fileFound = false;

                for (const fileName in logsByFile) {
                    const logContent = logsByFile[fileName];
                    const accordionId = fileName.replace(/[^a-zA-Z0-9]/g, ''); // 아코디언 ID로 사용할 수 있도록 특수문자 제거

                    if (logContent && !logContent.error) {
                        fileFound = true;
                        const tableRows = logContent.map(log => `
                            <tr>
                                <td><pre class="mb-0 bg-light p-1 rounded" style="white-space: pre-wrap; word-break: break-all;">${log.query}</pre></td>
                                <td class="text-end">${log.numberOfTimesRun.toLocaleString()}</td>
                                <td class="text-end">${log.totalRowsRead.toLocaleString()}</td>
                                <td class="text-end">${log.totalRowsWritten.toLocaleString()}</td>
                                <td class="text-end">${parseFloat(log.totalDurationMs).toFixed(2)}</td>
                            </tr>
                        `).join('');

                        accordionHTML += `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading-${accordionId}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${accordionId}" aria-expanded="false" aria-controls="collapse-${accordionId}">
                                        ${fileName}
                                    </button>
                                </h2>
                                <div id="collapse-${accordionId}" class="accordion-collapse collapse" aria-labelledby="heading-${accordionId}" data-bs-parent="#s3LogsAccordion">
                                    <div class="accordion-body">
                                        <table class="table table-bordered table-sm">
                                            <thead class="table-light"><tr><th>Query</th><th>실행 횟수</th><th>총 읽은 행</th><th>총 쓴 행</th><th>총 시간(ms)</th></tr></thead>
                                            <tbody>${tableRows}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>`;
                    }
                }
                accordionHTML += '</div>';
                s3ContentResultsDiv.innerHTML = fileFound ? accordionHTML : '<p>선택한 날짜 범위에 해당하는 S3 로그 파일이 로컬에 없습니다. 먼저 "S3 로그 다운로드"를 실행해주세요.</p>';

                // "모든 쿼리 파싱하기 (S3)" 버튼 활성화
                if (fileFound) {
                    document.getElementById('parseAllS3QueriesBtn').disabled = false;
                }

            } catch (error) {
                s3ContentResultsDiv.innerHTML = `<p class="text-danger">S3 로그를 읽는 데 실패했습니다: ${error.message}</p>`;
            }
        });

        document.getElementById('parseAllS3QueriesBtn').addEventListener('click', () => {
            if (Object.keys(s3LogsData).length === 0) {
                alert('먼저 "S3 로그 불러오기"를 실행하여 로그 목록을 불러와주세요.');
                return;
            }

            const allParsedQueries = [];
            for (const fileName in s3LogsData) {
                const logContent = s3LogsData[fileName];
                if (logContent && Array.isArray(logContent)) {
                    logContent.forEach(log => {
                        const fullQuery = log.query || '';
                        const match = fullQuery.match(/^INSERT INTO AuditLogs.*?VALUES\('((?:[^']|'')*)'/);
                        if (match && match[1]) {
                            allParsedQueries.push(match[1].replace(/''/g, "'"));
                        }
                    });
                }
            }

            const queryParseModal = new bootstrap.Modal(document.getElementById('queryParseModal'));
            const parsedQueryTextarea = document.getElementById('parsedQueryTextarea');
            parsedQueryTextarea.value = allParsedQueries.length > 0 ? allParsedQueries.join('\n\n---\n\n') : "파싱 가능한 AuditLog 쿼리가 없습니다.";
            queryParseModal.show();
        });
    </script>
</body>
</html>